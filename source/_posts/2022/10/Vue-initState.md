---
title: Vueï¼šbeforeCreate -> created <W8>
tags:
  - Vue
  - æºç 
  - æ·±å…¥æµ…å‡º-Vue-js
categories:
  - [ç¬”è®°]
  - [æ—¥å¸¸]
  - [æ¯å‘¨ä¸€ç¯‡]
mathjax: false
date: 2022-10-22 15:21:59
---

{% asset_img banner.png %}

> å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒVue åœ¨ `beforeCreate -> created` é˜¶æ®µï¼ŒæŒ‰è¿™ä¸ªæ­¥éª¤è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚æŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œä¹Ÿå°±æ„å‘³ç€åè€…åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å‰è€…å·²ç»åˆå§‹åŒ–çš„å˜é‡ã€‚ä¾‹å¦‚ï¼šåœ¨ `data` ä¸­å¯ä»¥ä½¿ç”¨ `methods` é‡Œå®šä¹‰çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ç”¨ `props` å¼•å…¥çš„å±æ€§è¿›è¡Œåˆå§‹åŒ–ã€‚

## initInjections

_`inject` çš„ä½¿ç”¨è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://v2.cn.vuejs.org/v2/api/#provide-inject)ã€‚_

- å…ˆè·å–å½“å‰å®ä¾‹ä¸Šæ³¨å†Œçš„ `inject`ï¼Œè¯»å–æ¯ä¸€ä¸ª `key`ï¼›

- ç„¶åè‡ªåº•å‘ä¸Šä¸æ–­å¾ªç¯è·å–çˆ¶ç»„ä»¶çš„ `provide` ä¸­æ˜¯å¦æœ‰æä¾›è¯¥ `key`ï¼š

  ```js
  // è‡ªåº•å‘ä¸Šå¾ªç¯ï¼Œè·å–çˆ¶ç»„ä»¶çš„ provide
  let curr = this
  while (curr) {
    if (curr.provide && key in curr.provide) {
      // ...
      break
    }
    curr = curr.$parent
  }
  ```

  - è‹¥æ‰¾åˆ°äº†ï¼Œåˆ™è·³å‡ºå¾ªç¯ï¼Œå¹¶è¿”å›ç»“æœï¼›
  - è‹¥æœªæ‰¾åˆ°ï¼Œåˆ™ä½¿ç”¨é…ç½®çš„é»˜è®¤å€¼ `default`ï¼›
  - ç‰¹æ®Šçš„ï¼Œå¯¹äº `default` ä¸º `function` ç±»å‹ï¼ˆéåŸå§‹å€¼çš„é»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä¼šå°†è¯¥æ–¹æ³•é€šè¿‡ `call` ä¿®æ”¹ `this` ä¸ºå½“å‰å®ä¾‹åï¼Œå†å°†æ‰§è¡Œç»“æœè¿”å›ï¼›
  - å¦‚æœæ—¢æ²¡æ‰¾åˆ°ï¼Œä¹Ÿæ²¡è®¾ç½® `default`ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª `éç”Ÿäº§è­¦å‘Š`ã€‚

  <b>

- ç„¶åå¯¹äºæ”¶é›†åˆ°çš„ç»“æœï¼Œä¼šéå†æ¯ä¸€ä¸ª `key`ï¼Œç„¶åé€šè¿‡ `defineReactive` æ³¨å†Œåˆ°å½“å‰å®ä¾‹ä¸Šï¼Œè€Œåœ¨ `defineReactive` å‰ä¼šæœ‰ä¸€ä¸ª "å–æ¶ˆå“åº”å¼" çš„æ“ä½œï¼š

  ```js
  observerState.shouldConvert = false
  ```

  è¿™ä¸€æ­¥å°±æ˜¯é€šçŸ¥ `defineReactive` ä¸è¦å°†æ¥ä¸‹æ¥æŒ‚è½½çš„æ•°æ®è½¬æ¢æˆå“åº”å¼æ•°æ®ï¼Œè¿™ä¹Ÿå°±å°è¯äº†å®˜æ–¹è¯´çš„ `inject` æ³¨å…¥çš„å†…å®¹ä¸æ˜¯å“åº”å¼æ•°æ®ã€‚å…¶å®å°±æ˜¯æŠŠæä¾›çš„ `provide` çš„å†…å®¹åœ¨å¼•å…¥ `inject` çš„å®ä¾‹ä¸Šï¼Œé‡æ–°å¤åˆ¶äº†ä¸€ä»½ã€‚å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåªæ˜¯å€¼å¤åˆ¶ï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶ä¸æ˜¯å“åº”å¼æ•°æ®ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¼•ç”¨ç±»å‹ï¼Œè¿˜æ˜¯å¼•ç”¨çš„åŒä¸€ä¸ªåœ°å€ï¼Œå¦‚æœæºæ•°æ®æ˜¯å“åº”å¼çš„ï¼Œé‚£ä¹ˆ `inject` å¼•å…¥çš„ä¹Ÿæ˜¯å“åº”å¼æ•°æ®ã€‚

  å¦‚æœæƒ³å®ç°åŸºç¡€æ•°æ®ç±»å‹çš„å“åº”å¼å‘¢ï¼Ÿæ¢ä¸ªè§’åº¦ï¼Œå¦‚æœæˆ‘ä»¬æŠŠ `provide` æä¾›çš„å±æ€§çš„ `this` ç»‘å®šåœ¨åŸå®ä¾‹ä¸Šï¼Œé‚£ä¹ˆæ˜¯å¦å°±èƒ½é€šè¿‡åŸå®ä¾‹çš„ `this` è®¿é—®åˆ°åŸå®ä¾‹ä¸Šçš„ä¸€äº›å“åº”å¼çš„æ•°æ®ï¼Ÿé‚£ä¹ˆ `inject` æ³¨å…¥çš„å†…å®¹æ˜¯ä¸æ˜¯å°±æ˜¯å“åº”å¼çš„å‘¢ï¼Ÿ

  çœ‹ä¸€ä¸ªä¾‹å­ï¼š

  <b>

  - çˆ¶ç»„ä»¶

    ```js
    // parent
    <template>
      <div>
        <input v-model="msg"></input>
      </div>
    </template>

    <script>
    export default {
      provide() {
        return {
          getMsg: () => this.msg,
          getMsg2() { return this.msg },
          getMsg3: this.getMsg3,
        };
      },
      data() {
        return {
          msg: "parent msg",
        };
      },
    };
    </script>
    ```

    <b>

  - å­ç»„ä»¶

    ```js
    // child
    <template>
      <div>
        <p>getMsg: {{ msg1 }}</p>
        <p>getMsg2: {{ msg2 }}</p>
        <p>getMsg3: {{ msg3 }}</p>
      </div>
    </template>

    <script>
    export default {
      inject: ["getMsg", "getMsg2", "getMsg3"],
      computed: {
        msg1() {
          return this.getMsg()
        },
        msg2() {
          return this.getMsg2()
        },
        msg3() {
          return this.getMsg3()
        }
      }
    }
    </script>
    ```

å­ç»„ä»¶ä¸­çš„ `msg1` å’Œ `msg3` æ˜¯å“åº”å¼çš„ï¼Œè€Œ `msg2` ä¸ºç©ºï¼ˆ`""`ï¼‰ã€‚è¿™å…¶å®å°±æ˜¯ `this` æŒ‡å‘çš„é—®é¢˜ï¼š

- `msg1`ï¼šç®­å¤´å‡½æ•°çš„ `this` æ˜¯ç”±åˆ›å»ºæ—¶çš„ç¯å¢ƒå†³å®šçš„ï¼Œä¹Ÿå³ `this == ParentVm(çˆ¶ç»„ä»¶å®ä¾‹)`ï¼Œæ‰€ä»¥ `getMsg() == "parent msg"`ã€‚
- `msg2`ï¼šæ­£å¸¸çš„å‡½æ•°è°ƒç”¨çš„ `this` ç”±å½“å‰çš„æ‰§è¡Œç¯å¢ƒå†³å®šï¼Œä¹Ÿå³ `this == ChildVm(å­ç»„ä»¶å®ä¾‹)`ï¼Œå› ä¸ºå­ç»„ä»¶ä¸Šæ²¡æœ‰å®šä¹‰ `msg`ï¼Œæ‰€ä»¥ `getMsg2() == undefined`ï¼Œé€šè¿‡ `{{}}` æ¸²æŸ“åˆ°é¡µé¢ä¸Šå°±æ˜¯ `""(ç©ºå­—ç¬¦ä¸²)`ã€‚
- `msg3`ï¼šæ ¹æ®ç»“æœè®ºï¼Œ`getMsg` å’Œ `getMsg3` çš„ `this` éƒ½æŒ‡å‘ `ParentVm`ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ° `methods` çš„åˆå§‹åŒ–äº†ï¼Œåœ¨ä¸‹é¢ `initMethods` ç« èŠ‚é‡Œä¼šæœ‰è¯¦ç»†è¯´æ˜ã€‚

## initState

### initProps

_`props` çš„ä½¿ç”¨è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/components-props.html)ã€‚_

- åœ¨è§£ææ¨¡æ¿ç”Ÿæˆ render å‡½æ•°çš„é˜¶æ®µï¼Œä¼šå°†è§£æåˆ°çš„ `props` æ•°æ®ä¼ é€’ç»™å­ç»„ä»¶ï¼Œåœ¨å­ç»„ä»¶ä¸­ä½¿ç”¨ `props` ä¸­çš„å‚æ•°ï¼Œä¼šè§¦å‘å¯¹åº”å‚æ•°çš„ `getter`ï¼Œç„¶åå°†å­ç»„ä»¶ä¸­å¯¹åº”çš„ `Watcher` æ”¾å…¥å½“å‰å‚æ•°çš„ä¾èµ–ä¸­ï¼Œä»è€Œå®ç°åœ¨çˆ¶ç»„ä»¶æ›´æ–°å€¼åï¼Œå­ç»„ä»¶ä¹Ÿä¼šåŒæ­¥æ›´æ–°ã€‚
- åœ¨çˆ¶ç»„ä»¶æ¨¡æ¿ä¸­ç»™å­ç»„ä»¶ä¼ é€’å±æ€§ï¼Œæ—¢å¯ä»¥ä»¥çŸ­æ çš„å½¢å¼ `user-name`ï¼Œä¹Ÿå¯ä»¥ç”¨å°é©¼å³°çš„å½¢å¼ `userName`ï¼Œä¸è¿‡åœ¨å­ç»„ä»¶ä¸­æ³¨å†Œåˆ° `props` ä¸­ï¼Œåªèƒ½ä»¥ `userName` çš„å½¢å¼æ¥æ”¶ã€‚
- åªæœ‰åœ¨å½“å‰æ˜¯æ ¹ç»„ä»¶æ—¶ï¼Œæ‰ä¼šå°† `props` ä¸­çš„æ•°æ®è½¬æ¢ä¸ºå“åº”å¼æ•°æ®ã€‚å› ä¸ºä»çˆ¶ç»„ä»¶ä¼ å…¥çš„ `props` éƒ½å·²ç»åœ¨çˆ¶ç»„ä»¶ä¸­å®šä¹‰æˆå“åº”å¼äº†ï¼Œå­ç»„ä»¶åªæ˜¯å¼•å…¥ï¼Œå¹¶åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå†å¾€ `props` é‡Œæ·»åŠ å¯¹åº”çš„ä¾èµ–ï¼Œæ‰€ä»¥ä¸éœ€è¦è½¬ä¸ºå“åº”å¼ã€‚ç‰¹æ®Šçš„ï¼Œå¯¹äºçˆ¶ç»„ä»¶æ²¡æœ‰æä¾›ï¼Œä¸”å®šä¹‰äº† `default` çš„ `prop`ï¼Œéœ€è¦å°†é»˜è®¤å€¼è½¬ä¸ºå“åº”å¼ã€‚
- `Boolean` ç±»å‹ `prop` çš„å¤„ç†ï¼šä»¥ä¸‹å››ç§æƒ…å†µéƒ½ä¼šå°†å­ç»„ä»¶çš„ `prop` è®¾ç½®ä¸º `true`ï¼š

  ```js
  <child name />
  <child name="name" />
  <child userName="user-name" />
  <child user-name="user-name" />
  ```

  æ¯”å¯¹æ—¶ï¼Œä¼šå°† `key` è¿›è¡Œé©¼å³°è½¬åŒ–ï¼Œå³ `userName -> user-name`ï¼Œå¦‚æœä¸æä¾›çš„å€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆä¹Ÿè®¾ç½®ä¸º `true`ã€‚

- æœ€åï¼Œéå† `props` ä¸­çš„æ¯ä¸€é¡¹ï¼Œç„¶åå°†ä¸åœ¨å½“å‰ `vm` å®ä¾‹ä¸Šçš„ï¼Œè®¾ç½®ä¸€å±‚ä»£ç†ï¼Œç„¶åæŒ‚è½½åœ¨ `vm` å®ä¾‹ä¸Šã€‚

### initMethods

- éå† `$options.methods`ï¼Œå…ˆæ£€éªŒæ˜¯å¦æœ‰ä¸ `props` ä¸­çš„æœ‰é‡å¤çš„ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª `éç”Ÿäº§è­¦å‘Š`ã€‚æ³¨æ„è¿™åªæ˜¯ä¸€ä¸ªè­¦å‘Šï¼Œå¦‚æœæ²¡æœ‰ä¿®æ­£ï¼Œé‚£ä¹ˆä¾ç„¶è¿˜ä¼šå°†å½“å‰ `methods` æŒ‚è½½åœ¨å½“å‰å®ä¾‹ä¸Šï¼ˆä¹Ÿå³ï¼Œå¦‚æœæŸä¸€ä¸ª `key` åŒæ—¶å­˜åœ¨äº `props` å’Œ `methods` ä¸Šï¼Œé‚£ä¹ˆæœ€åä½¿ç”¨æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ `methods` ä¸Šçš„ï¼‰ã€‚
- æŒ‚è½½æ—¶ä¼šé€šè¿‡ `bind` ä¿®æ”¹ `methods` çš„ `this` ä¸ºå½“å‰å®ä¾‹ã€‚

### initData

- ç‰¹æ®Šçš„ï¼Œ`data` å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªè¿”å›å¯¹è±¡çš„å‡½æ•°ã€‚
- éå† `data` çš„æ ¡éªŒé˜¶æ®µï¼š

  - å…ˆåˆ¤æ–­ï¼Œå¦‚æœå±æ€§å·²å­˜åœ¨äº `methods` ä¸­ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª `éç”Ÿäº§è­¦å‘Š`ï¼›
  - å†åˆ¤æ–­ï¼Œå¦‚æœå±æ€§å·²å­˜åœ¨äº `props` ä¸­ï¼ŒæŠ›å‡ºä¸€ä¸ª `éç”Ÿäº§è­¦å‘Š`ï¼Œä½†æ˜¯ä¸ä¼šæŒ‚è½½ï¼Œåªæœ‰å½“å‰å±æ€§ä¸ä»¥ `$` æˆ– `_` å¼€å¤´æ—¶ï¼Œæ‰ä¼šä»£ç†åˆ°å®ä¾‹ä¸Šã€‚

{% blockquote %}

Vue å†…éƒ¨ä½¿ç”¨çš„ä»£ç†æ–¹æ³•

```js
const noop = _ => _
const sharePropertyDefinition = {
  enumerable: true,
  configurable: true,
  get: noop,
  set: noop
}

function proxy(target, sourceKey, key) {
  sharePropertyDefinition.get = function proxyGetter() {
    return this[sourceKey][key]
  }

  sharePropertyDefinition.set = function proxySetter(val) {
    this[sourceKey][key] = val
  }

  Object.defineProperty(target, key, sharePropertyDefinition)
}
```

{% endblockquote %}

### initComputed

_`computed` çš„ä½¿ç”¨è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/computed.html#%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7)ã€‚_

- å…ˆæ£€éªŒï¼Œå¦‚æœå½“å‰çš„å±æ€§åå·²å­˜åœ¨ `vm` ä¸Šï¼Œåˆ™ä¸ä¼šå¤„ç†è¿™ä¸ªå±æ€§ã€‚
- æ”¶é›†å½“å‰ `getter` ä¸­æ‰€æœ‰ç”¨åˆ°çš„å±æ€§çš„ä¾èµ–ï¼Œå½“è¿™äº›å±æ€§å˜åŒ–æ—¶ï¼Œé€šçŸ¥ `computed Watcher` å»æ›´æ–°ã€‚

{% blockquote %}

åœ¨ 18 å¹´æœ‰äººæäº†ä¸€ä¸ª _Issue_ ï¼š`computed` ä¾èµ–çš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œä½† `computed` çš„å€¼æ²¡æœ‰æ”¹å˜ï¼Œä»ç„¶ä¼šè§¦å‘ `render`ã€‚å®˜æ–¹è™½ç„¶åœ¨åç»­ä¹Ÿé‡æ–°è§£å†³äº†ï¼Œä¸è¿‡æˆ‘æœ€è¿‘ç”¨æœ€æ–°ç‰ˆçš„ _Vue2.7_ è¯•äº†è¯•ï¼Œè²Œä¼¼è¿˜å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼ˆ[æˆ³è¿™é‡Œ](https://codepen.io/olderk/pen/XWqvyKV)ï¼‰ã€‚

{% endblockquote %}

ç²—ç•¥åœ°çœ‹äº†çœ‹ï¼Œå°è¯•è§£é‡Šä¸€ä¸‹ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªï¼š_sum_ ä¾èµ–äº _a_ å’Œ _b_ ï¼Œå…¶ä¸­ _sum_ çš„ _Watcher_ æœ‰ä¸€ä¸ªï¼š`render Watcher`ï¼ŒæŒ‰ç†è¯´ _a_ å’Œ _b_ çš„ _Watcher_ åº”è¯¥åªæœ‰ä¸€ä¸ª `computed Watcher`ï¼Œé‚£å°±æ˜¯å½“ _a_ æˆ– _b_ å‘ç”Ÿå˜åŒ–åï¼Œé€šçŸ¥è®¡ç®—å±æ€§ _sum_ é‡æ–°è®¡ç®—ï¼Œä½†æ˜¯è¿™æ ·æ— æ³•é€šçŸ¥ _sum_ çš„ _Watcher_ å»æ›´æ–°ã€‚æ‰€ä»¥ _sum_ çš„æ¯ä¸ªä¾èµ–é‡Œéƒ½ä¼šæŠŠ _sum_ çš„ _Watcher_ å­˜ä¸€ä»½ï¼Œä¹Ÿå³ _a_ å’Œ _b_ çš„ _Watcher_ é‡Œè¿˜æœ‰ä¸€ä»½ `render Watcher`ã€‚ç„¶åå°±å¯¼è‡´ï¼Œå°±ç®— _a_ å’Œ _b_ çš„å€¼åŒæ—¶æ”¹å˜äº†ï¼Œä½†æ˜¯ _sum_ çš„ç»“æœæ²¡å˜ï¼Œè¿˜æ˜¯ä¼šè§¦å‘ `render Watcher`ï¼Œé‡æ–°æ‰§è¡Œä¸€æ¬¡ _render_ ã€‚è™½ç„¶åœ¨ _diff_ é˜¶æ®µï¼Œæœ€æ–°çš„ä¸€æ¬¡ _render_ æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œä½†è¿˜æ˜¯ä¼šé€ æˆæ€§èƒ½çš„æµªè´¹ã€‚ï¼ˆä¸ªäººæ„šè§å“ˆ ğŸ˜‚ï¼‰

```js
<template>
  <div>{{ sum }}</div>
</template>
<script>
export default {
  computed: {
    sum() {
      return this.a + this.b
    }
  }
}
</script>
```

### initWatch

_`watch` çš„ä½¿ç”¨è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/computed.html#%E4%BE%A6%E5%90%AC%E5%99%A8)ã€‚_

åˆå§‹åŒ–æ—¶ï¼Œåˆ›å»º `Watcher` ä¸ `$watch` ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ã€‚å‚æ•°ç±»å‹å¯ä»¥ä¸º `String`ã€`Function`ã€`Object` å’Œ `Array` è¿™å››ç§ç±»å‹ã€‚

```js
watch: {
  a: function(newVal, oldVal) {},
  b: 'handlerWatchB',
  c: {
    handler(newVal, oldVal) {},
    deep: false,
    immediate: false
  },
  d: [
    function handlerWatchD1(newVal, oldVal){},
    function handlerWatchD2(newVal, oldVal){},
  ]
}
```

é‰´äºå‚æ•°çš„ç‰¹æ®Šæ€§ï¼Œéœ€è¦å¯¹ç±»å‹ä¸º `Array` çš„ç‰¹æ®Šå¤„ç†ï¼Œæ‰¹é‡åˆ›å»º `Watcher`ã€‚

```js
// åˆ›å»º Watcher
function createWatcher(vm, expOrFn, handler, options) {
  if (isPlainObject(handler)) {
    options = handler
    handler = handler.handler
  }
  if (typeof handler === "string") {
    handler = vm[handler]
  }
  return vm.$watch(expOrFn, handler, options)
}
```

## initProvide

_`provide` çš„ä½¿ç”¨è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://v2.cn.vuejs.org/v2/api/#provide-inject)ã€‚_

- å¦‚æœæ˜¯ `object` ç±»å‹ï¼Œåˆ™ç›´æ¥æŒ‚è½½åœ¨å½“å‰å®ä¾‹ä¸Šï¼›
- å¦‚æœæ˜¯ `function` ç±»å‹ï¼Œåˆ™é€šè¿‡ `call` ä¿®æ”¹ `this` ä¸ºå½“å‰å®ä¾‹åï¼Œå†å°†æ‰§è¡Œç»“æœè¿”å›ã€‚
